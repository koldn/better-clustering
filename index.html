<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8">

    <title>Better Clustering</title>

    <meta name="description" content="Bettter Clustering">
    <meta name="author" content="Dmitriy Kolmogortsev">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/white.css" id="theme">

    <link rel="stylesheet" href="css/hljs/vs.css" id="highlight-theme">

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="css/custom.css">
    <style>
        .reveal pre {
            background: none;
            border: none;
            box-shadow: none;
            width: auto;
        }
        
        .reveal pre code {
            color: black;
            background: none;
            box-shadow: none;
            max-height: none;
            line-height: 1.5;
            overflow: hidden;
            font-size: 82%;
        }
        
        .stroke {
            text-decoration: line-through;
        }
        
        .red-text {
            color: red;
        }
    </style>
</head>

<body>

    <div class="reveal">
        <div class="footer">
            <span class="corp-name"><b>NAUMEN </b></span>Колмогорцев Дмитрий
        </div>
        <div class="slides">
            <section>
                <h1>Кластеризация 2.0</h1>
                <h5>Dark ages -> Bright Future</h5>
            </section>
            <section>
                <h1>Disclaimer</h1>
                <div>
                    Далее будут рассмотрены проблемы одного крайне крупного клиента.
                </div>
            </section>
            <section>
                <h2>Начало. Идеальная архитектура</h2>
                <img src="img/start.png"/>
            </section>
            <section>
                <h2>Основные источники проблем</h2>
                <ol>
                    <li>Отчёты</li>
                    <li>Фоновые процессы</li>
                </ol>
            </section>
            <section>
                <h2>Отчёты</h2>
            </section>
            <section>
                <h4>Отчёты. Проблемы</h4>
                <ul>
                    <li class="fragment">Отчёты работают через планировщик, занимая поток</li>
                    <li class="fragment">Построение отчёта 2-18 часов (в зависимости от параметров)</li>
                    <li class="fragment">Отчёты висят в очереди долгое время, раздражая пользователей</li>
                </ul>
            </section>
            <section>
                <h1>Отчетная нода</h1>
            </section>
            <section>
                <h2>Отчетная нода</h2>
                <ul>
                    <li class="fragment">Отдельный инстанс SMP</li>
                    <li class="fragment">Работа по JMS</li>
                    <li class="fragment">Работа без кешей</li>
                    <li class="fragment">Работа с БД только на чтение</li>
                </ul>
            </section>
            <section>
                <h2>Отчетная нода.JMS</h2>
                <ul>
                    <li class="fragment">Очередь быстрых отчетов (~ 2ч)</li>
                    <li class="fragment">Очередь средний отчётов (~ 6ч)</li>
                    <li class="fragment">Очередь "Исторических" отчётов (~ 10 ч)</li>
                    <li class="fragment">Очередь получения готовых отчётов</li>
                </ul>
                <div class="fragment">На каждой очереди можно настроить кол-во обработчиков</div>
            </section>
            <section>
                <h2>"Отчетная нода"</h2>
                <img src="img/reports.png"/>
            </section>
            <section>
                <h2>Фоновые процессы</h2>
            </section>
            <section>
                <h2>Фоновые процессы. Проблемы</h2>
                <ul>
                    <li class="fragment">Большой поток входящих JMS сообщений</li>
                    <li class="fragment">Большое кол-во обработчиков приводит к задержкам обработки запросов пользователей</li>
                    <li class="fragment">Сервер приложений горит</li>
                </ul>
            </section>

            <section>
                <h4>Вопрос</h4>
                <span>А может там кластер развернем?</span>
                <div class="fragment">
                    <img src="img/no.gif"/>
                </div>
            </section>
            <section>
                <h3>Cluster 1.0</h3>
                <img src="img/old-sluster.png"/>
            </section>
            <section>
                <h3>Чем плох:</h3>
                <ul>
                    <li class="fragment">
                        Всё взаимодействие между узлами синхронное<span class="fragment">(грех)</span>
                    </li>
                    <li class="fragment">
                        Узлы используют два независимых канала связи (JGroups)
                    </li>
                    <li class="fragment">
                        Тяжело вводить новые узлы
                    </li>
                </ul>
            </section>
            <section>
                <h5>2 канала</h5>
                <img src="img/channels.png"/>
            </section>
            <section>
                <h3>"Скриптовая нода"</h3>
            </section>
            <section>
                <h5>Скриптовая нода</h5>
                <ul>
                    <li class="fragment">Новый инстанс SMP</li>
                    <li class="fragment">Выполняет фоновые процессы (почти весь JMS) и Quartz</li>
                    <li class="fragment">Один канал JGroups</li>
                    <li class="fragment">Основное событие в сети - инвалидация L2 cache Hibernate</li>
                    <li class="fragment">Ручная синхронизация метаданных</li>
                    <li class="fragment">Без "основного" приложения затихает</li>
                </ul>
                
            </section>
            <section>
                <h5>Скриптовая нода</h5>
                <img src="img/script-node.png"/>
            </section>
            <section>
                <h5>Production launch #1</h5>
                <div>
                    В прайм тайм нагрузки всё стремительно заблокировалось.<br/>
                    <span class="fragment">Беда в синхронной обработке и поведении одного протокола в JGroups</span>
                </div>
            </section>
            <section>
                <h5>JGroups.NAKACK2</h5>
                <div>
                    "NAKACK2 provides reliable delivery and FIFO (= First In First Out) properties for messages sent to all nodes in a cluster. "
                </div>
                <pre>
                    <code class="java">
/**
 * Efficient way of checking whether another thread is already processing messages 
 * from sender. If that's the case, we return immediately and let the existing thread
 * process our message...
 */
protected void removeAndPassUp(...) {
    final AtomicBoolean processing=buf.getProcessing();
    if(!processing.compareAndSet(false, true))
        return;
}
                    </code>
                </pre>
            </section>
            <section>
                <h5>JGroups.NAKACK2</h5>
                <p>
                    Многопоточной обработки сообщений от одного узла может и не быть!
                </p>
                <div class="fragment">
                    <span>Solution</span>
                    <pre>
                        <code class="java">
//Что-то будет таки синхронным                        
if(event.isSyncEvent()){
    doProcessMessage(event,response);
    return;
}
//Оффлоад на свой executor, отпускаем поток JGroups
executor.submit(() -&gt; doProcessMessage(event, response));                            
                        </code>
                    </pre>
                </div>
            </section>
            <section>
                    <h5>Production launch #2</h5>
                    <div>
                        Снова всё стремительно блокируется в JGroups
                    </div>
                    <div class="fragment">
                        А может ну это всё? Запустим таки кластер только с инвалидацией L2 Cache?
                        IS умеет в аснихронщину
                    </div>
            </section>
            <section>
                    <h4>Async Infinispan</h4>
                    <span>
                        Me: setup async invalidation
                    </span>
                    <br/>
                    <span class="fragment">
                        IS: does something synchronous
                    </span>
                    <br/>
                    <span class="fragment">
                        Me:<br/>
                        <img src="img/tom.jpg" width="60%"/>
                    </span>
                </section>
            <section>
                <h5>JGroups.FLOW_CONTROL</h5>
                <pre>
                    <code class="java">
/**
* Simple flow control protocol based on a credit system. Each sender has a number of credits
* (bytes to send). When the credits have been exhausted, the sender blocks. Each receiver 
* also keeps track of
* how many credits it has received from a sender. When credits for a sender fall below
* a threshold, the receiver sends more credits to the sender.
*/
public abstract class FlowControl...  {
    /**
     * Max number of bytes to send per receiver until 
     * an ack must be received before continuing sending
     */
    protected long max_credits=500000;
}             
                    </code>
                </pre>
            </section>
            <section>
                    <h5>JGroups.FLOW_CONTROL</h5>
                    <pre>
                        <code class="java">
//Настройка кредитов
flowControl.setMaxCredits("1024M");
                        </code>
                    </pre>
                    <div>
                        Отправляем события асинхронно
                    </div>
                    <pre>
                        <code class="java">
if(!event.isSyncEvent()){
    //Оффлоад на executor
    executor.submit(() -&gt clusterBus.sendEvent(event));
    return;
}
//Что-то будет таки синхронным 
clusterBus.sendEvent(event);    
                        </code>
                    </pre>
                </section>
            <section>
                <h5>Production launch #3</h5>
                <div>
                    Всё работает! Ура! <span class="fragment">Нет =(</span>
                    <br/>
                    <span class="fragment">Всё периодически останавливается из-за персональных настроек пользователя</span><br>
                    <span class="fragment">Они, внезапно, считались метаданными приложения.</span>
                </div>
            </section>
            <section>
                <h5>Production launch #4-#5</h5>
                <div>
                    Оптимизации и таки успешный запуск и работа по сей день.
                </div>
            </section>
            <section>
                <h4>Cluster. Bright future</h4>
                <ul>
                    <li class="fragment">N Fronends + M Backends</li>
                    <li class="fragment">"Главное приложение" -> Frontend</li>
                    <li class="fragment">"Скриптовая нода" -> Backend</li>
                    <li class="fragment">Universal = (Frontend + Backend)</li>
                    <li class="fragment">Sticky sessions</li>
                </ul>
            </section>
            <section>
                <h4>
                    Один из вариантов, который вот-вот будет деплоиться.
                </h4>
                <img src="img/cluster.png"/>
            </section>
            <section>
                <h2>Индексация</h2>
                <ul>
                    <li class="fragment">ISDirectory - всё</li>
                    <li class="fragment">У каждой ноды своя очередь на индексацию</li>
                    <li class="fragment">У каждой ноды свой дисковый индекс</li>
                </ul>
            </section>
            <section>
                <h4>Всё классно<span class="fragment">, но есть JAXB</span></h4>
                <div class="fragment">
                    Он странный.
                </div>
                <div class="fragment">
                    Или мы странные.
                </div>
            </section>
            <section>
                <h3>JAXB</h3>
                <div>Инициализируем настройку добавленную на другом узле</div>
                <pre>
                    <code class="java" data-noescape>
//Object о was added on other node, here we initialize that object 
//with integrity check
Object o = cache.get(key)                        
String xml = xmlUtils.toXml() //JAXB here
if(!xml.equals(xmlFromDb))<span class="fragment">//Порой это вычислялось в  false</span>
{ 
    saveToDb(xml);
}
                    </code>
                </pre>
            </section>
            <section data-transition="fade-in slide-out" data-background-image="img/pikachu.jpg" data-background-size="contain">

            </section>
            <section>
                <h2>Странность</h2>
                <div>Одна и таже операция в разных частях приложения работает по-разному</div>
                <div class="fragment">
                        <pre>
                            <code class="xml" data-noescape>
                    &lt;!-- Сохранение настройки в БД --&gt;
                    &lt;description lang="ru"/&gt;
                    <span class="fragment">
                    &lt;!-- Получение свежесохраненной настройки --&gt;
                    &lt;description lang="ru"&gt;&lt;/description&gt;
                                </span>
                            </code>
                        </pre>
                </div>
            </section>
            <section>
                    <h2>Странность</h2>
                    <div>Одна и таже операция в разных частях приложения работает по-разному</div>
                    <div>
                            <pre>
                                <code class="xml" data-noescape>
                        &lt;!-- Сохранение настройки в БД --&gt;
                        &lt;description lang="ru"/&gt;
                        <span class="fragment">&lt;!-- LocalizedString@12345[null,lang=ru] --&gt;</span>

                        &lt;!-- Получение свежесохраненной настройки --&gt;
                        &lt;description lang="ru"&gt;&lt;/description&gt;
                        <span class="fragment">&lt;!-- LocalizedString@54321[lang=ru] --&gt;</span>
                                    
                                </code>
                            </pre>
                    </div>
                </section>    
            <section>
                <H2>Результат</H2>
                <ul>
                    <li class="fragment">Асинхронное взаимодействие</li>
                    <li class="fragment">Любое кол-во узлов</li>
                    <li class="fragment">Балансировка нагрузки? Пожалуйста</li>
                    <li class="fragment">Горячий резерв? Пожалуйста</li>
                </ul>
            </section>
            <section>
                Q & A
            </section>
        </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
        // Full list of configuration options available at:
        // https://github.com/hakimel/reveal.js#configuration
        Reveal.initialize({
            controls: false,
            progress: true,
            history: true,
            center: true,
            slideNumber: true,

            transition: 'slide', // none/fade/slide/convex/concave/zoom

            // Optional reveal.js plugins
            dependencies: [{
                src: 'lib/js/classList.js',
                condition: function() {
                    return !document.body.classList;
                }
            }, {
                src: 'plugin/markdown/marked.js',
                condition: function() {
                    return !!document.querySelector('[data-markdown]');
                }
            }, {
                src: 'plugin/markdown/markdown.js',
                condition: function() {
                    return !!document.querySelector('[data-markdown]');
                }
            }, {
                src: 'plugin/highlight/highlight.js',
                async: true,
                condition: function() {
                    return !!document.querySelector('pre code');
                },
                callback: function() {
                    hljs.initHighlightingOnLoad();
                }
            }, {
                src: 'plugin/zoom-js/zoom.js',
                async: true
            }, {
                src: 'plugin/notes/notes.js',
                async: true
            }]
        });

        window.addEventListener("mousedown", handleClick, false);
        window.addEventListener("contextmenu", function(e) {
            e.preventDefault();
        }, false);

        function handleClick(e) {
            e.preventDefault();
            if (e.button === 0) Reveal.next();
            if (e.button === 2) Reveal.prev();
        }

        Reveal.addEventListener('fragmentshown', function(event) {
            if (event.fragment.id == 'aVotInet') {
                document.getElementById('checkNoBugs').classList.add("stroke");
            }
        });

        Reveal.addEventListener('fragmenthidden', function(event) {
            if (event.fragment.id == 'aVotInet') {
                document.getElementById('checkNoBugs').classList.remove("stroke");
            }
        });
    </script>

</body>

</html>